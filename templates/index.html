{{define "head"}}

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<title>GHOPI</title>

<style>
    #save .material-symbols-outlined {
        font-variation-settings:
        'FILL' 1,
        'wght' 300,
        'GRAD' -25,
        'opsz' 48;
        color:rgb(71, 181, 255);
        position: absolute;
        transition: all 0.5s;
      }
      #save .material-symbols-outlined:hover {
          color: rgb(37, 109, 133);
        }
      #save .material-symbols-outlined:active {
          color: rgb(22, 75, 97);
      }

      #save:hover {
        cursor:pointer;
      }
    .btn-sync__text .material-symbols-outlined {
        font-variation-settings:
        'FILL' 1,
        'wght' 600,
        'GRAD' -25,
        'opsz' 100;
        color: rgb(223, 246, 255);
        vertical-align: text-bottom;
        font-size: 24px;
      }
</style>
{{end}}

{{define "navbar"}}
<div class="collapse navbar-collapse" id="menuItems">
    <ul class="navbar-nav me-auto">
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="/" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Copy URL
            </a>
            <ul class="dropdown-menu" aria-labelledby="navbarDropdown" style="background-color: rgb(22, 75, 97);">
                <li>
                    <a class="dropdown-item" onclick="copyOP()" role="button">
                        <img class="me-1" src="static/img/op_logo.svg" title="open project logo" style="width: 20px;height: 20px;">
                        Copy Open Project endpoint
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" onclick="copyGithub()" role="button">
                        <img class="me-1" src="static/img/github_logo.svg" title="github logo" style="width: 20px;height: 20px;">
                        Copy Github endpoint
                    </a>
                </li>
                <li>
                    <!-- <a class="dropdown-item text-lgray" onclick="copyGitlab()" role="button">
                        <img class="me-1" src="static/img/gitlab_logo.svg" title="gitlab logo" style="width: 20px;height: 20px;">
                        Copy Gitlab endpoint
                    </a> -->
                </li>
            </ul>
        </li>
    </ul>
</div>
<div class="topnav-right">
    <button type="button" class="btn btn-sync me-3 btn-lg" onclick="loading()">
        <span class="btn-sync__text">
            Refresh 
            <span class="material-symbols-outlined">sync</span>
        </span>
    </button>
</div>
{{end}}

{{define "sidebar-top"}}
{{end}}

{{define "sidebar-bottom"}}
{{end}}

{{define "content"}}
<div class="container-fluid">
    <div class="row text-center mx-4 mt-4 mb-1">
        <div class="col-md-6 mb-3">
            <h4>Open Project</h4>
            <label class="mb-2">OpenProject instance URL:</label><br>
            <p>
                <input type="text" id="op_url" name="op_url">
                <a onclick="save()" id="save"><span class="material-symbols-outlined">save</span></a>
            </p>
            <form action="/op/login" method="post" enctype="multipart/form-data">
                <input type="submit" name="submit_op" value="Login"/>
            </form>
        </div>
        <div class="col-md-6 mb-3">
            <h4>Github</h4>
            <form action="/github/login" method="post" enctype="multipart/form-data">
                <input class="mt-2" type="submit" name="submit_gh" value="Login"/>
                <!-- <a href="/github/login">LOGIN</a></br> -->
            </form>
            <button class="btn btn-secondary mt-2" type="button" name="gh_webhook" onclick="gh_webhook()">WEBHOOK</button>

        </div>
        <!-- <div class="col-md-4 mb-3">
            <h4>Gitlab</h4>
            <label class="mb-2" for="gl_user">User:</label><br>
            <input type="text" id="gl_user" name="gluser" disabled><br>
            <label class="mb-2" for="gl_apikey">Api Key:</label><br>
            <input type="password" id="gl_apikey" name="gl_apikey" disabled><br>
            <input class="mt-1 me-1" type="checkbox" onclick="myFunction('gl_apikey')" disabled><label class="mt-1" style="font-size: 12px">Show key</label> 
        </div> -->
    </div>
    <!-- <div class="row text-center">
        <div class="col-md-12">
            <input type="submit" name="submit" value="Upload" disabled>
        </div>
    </div> -->
</div>
{{end}}

{{define "scripts"}}
<script>
    const url = (window.location.href).split(/[?#]/)[0] + "api/refresh";
    const theButton = document.querySelector(".btn-sync");

    function refresh(){
        fetch(url).then(res => {
            return res.text()
        }).then(text => {
            theButton.classList.remove("btn-sync--loading");
            let type = "";
            if (text.startsWith("Error")) { type = "error" }
            else { type = "success" }
            Swal.fire({
                title: "Finished refreshing tasks",
                text: text,
                icon: type
            })
        })
    }
    function loading(){
        refresh();
        theButton.classList.add("btn-sync--loading");
    }
</script>

<script>
    async function gh_webhook() {
        const { value: org } = await Swal.fire({
            title: 'Enter organization name',
            input: 'text',
            inputLabel: 'Organization:',
            showCancelButton: true,
            inputValidator: (value) => {
                if (!value) {
                return 'You need to write something!'
                }
                if (value.includes(" ")) {
                    return 'Organization names must not have blank spaces'
                }
            }
        })
        if(org) {
            const organization = {
                "organizationName": org
            };

            function postWebhook(data) {
                return new Promise(function (resolve, reject){
                    fetch('/github/webhook', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                    })
                    .then(
                        (response) => response.json().then(data =>{
                            resolve(data);
                        }),
                        (error) => {reject(error);}
                    );
                })
            }

            var result = await postWebhook(organization)
            if(result.hasOwnProperty('message')){
                msg = JSON.stringify(JSON.parse(JSON.stringify(result)).message)
                Swal.fire("Webhook creation failed", msg.replace(/["]/g, ""), "error")
            }
            else {
                Swal.fire("Webhook created", "Webhook was created successfully", "success")
            }  
        }
    }
</script>

<script>
    function save() {
        const url = (window.location.href).split(/[?#]/)[0] + "op/save-url";
        let input = document.getElementById("op_url");
        if (input.value === "") {
            input.value = "";
            input.placeholder = "URL cannot be blank";
        } else if (input.value.includes(" ")) {
            input.value = "";
            input.placeholder = "URL cannot contain spaces";
        } else {
            let data = {op_url: input.value};

            fetch("/op/save-url", {
                method: "POST",
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify(data)
            }).then(res => {
                Swal.fire("URL sent", res.json(), "success")
            });
        }


    }
</script>

<!-- <script>
    function myFunction(id) {
        var x = document.getElementById(id);
        if (x.type === "password") {
            x.type = "text";
        } else {
            x.type = "password";
        }
    }
</script> -->
{{end}}