{{define "head"}}

<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<title>Open Sync</title>
{{end}}

{{define "navbar"}}
<div class="collapse navbar-collapse" id="menuItems">
    <ul class="navbar-nav me-auto">
        <li class="nav-item">
            <a href="/instructions" class="nav-link">User Manual</a>
        </li>
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="/" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                Copy URL
            </a>
            <ul class="dropdown-menu bg-darkgray" aria-labelledby="navbarDropdown">
                <li>
                    <a class="dropdown-item text-lgray" onclick="copyOP()" role="button">
                        <img class="me-1" src="static/img/op_logo.svg" title="open project logo" style="width: 20px;height: 20px;">
                        Copy Open Project endpoint
                    </a>
                </li>
                <li>
                    <a class="dropdown-item text-lgray" onclick="copyGithub()" role="button">
                        <img class="me-1" src="static/img/github_logo.svg" title="github logo" style="width: 20px;height: 20px;">
                        Copy Github endpoint
                    </a>
                </li>
                <li>
                    <!-- <a class="dropdown-item text-lgray" onclick="copyGitlab()" role="button">
                        <img class="me-1" src="static/img/gitlab_logo.svg" title="gitlab logo" style="width: 20px;height: 20px;">
                        Copy Gitlab endpoint
                    </a> -->
                </li>
            </ul>
        </li>
    </ul>
</div>
<div class="topnav-right">
    <button type="button" class="btn btn-sync me-3 btn-lg" onclick="loading()">
        <span class="btn-sync__text">
            Refresh 
            <span class="material-symbols-outlined inline-icon">sync</span>
        </span>
    </button>
</div>
{{end}}

{{define "content"}}
<div class="container-fluid">
    <div class="row text-center mx-4 mt-4 mb-1">
        <div class="col-md-6 mb-3">
            <h4>Open Project</h4>
            <form action="/op/login" method="post" enctype="multipart/form-data">
                <label class="mb-2">OpenProject instance URL:</label><br>
                <input type="text" id="op_url" name="op_url"><br>
                <!-- <input class="mt-1 me-1" type="checkbox" onclick="myFunction('op_apikey')"><label class="mt-1" style="font-size: 12px">Show key</label>  -->
                <input class="mt-2" type="submit" name="submit_op" value="Login" disabled/>
                <a href="/op/login">LOGIN</a>
            </form>
        </div>
        <div class="col-md-6 mb-3">
            <h4>Github</h4>
            <form action="/github/login" method="post" enctype="multipart/form-data">
                <label class="mb-2">Github organization name:</label><br>
                <input class="mt-2" type="submit" name="submit_gh" value="Login"/>
                <!-- <a href="/github/login">LOGIN</a></br> -->
            </form>
            <button class="btn btn-secondary mt-2" type="button" name="gh_webhook" onclick="gh_webhook()">WEBHOOK</button>

        </div>
        <!-- <div class="col-md-4 mb-3">
            <h4>Gitlab</h4>
            <label class="mb-2" for="gl_user">User:</label><br>
            <input type="text" id="gl_user" name="gluser" disabled><br>
            <label class="mb-2" for="gl_apikey">Api Key:</label><br>
            <input type="password" id="gl_apikey" name="gl_apikey" disabled><br>
            <input class="mt-1 me-1" type="checkbox" onclick="myFunction('gl_apikey')" disabled><label class="mt-1" style="font-size: 12px">Show key</label> 
        </div> -->
    </div>
    <!-- <div class="row text-center">
        <div class="col-md-12">
            <input type="submit" name="submit" value="Upload" disabled>
        </div>
    </div> -->
</div>
{{end}}

{{define "scripts"}}
<script>
    const url = (window.location.href).split(/[?#]/)[0] + "api/refresh";
    const theButton = document.querySelector(".btn-sync");

    function refresh(){
        fetch(url).then(res => {
            return res.text()
        }).then(text => {
            theButton.classList.remove("btn-sync--loading");
            let type = "";
            if (text.startsWith("Error")) { type = "error" }
            else { type = "success" }
            Swal.fire({
                title: "Finished refreshing tasks",
                text: text,
                icon: type
            })
        })
    }
    function loading(){
        refresh();
        theButton.classList.add("btn-sync--loading");
    }
</script>

<script>
    async function gh_webhook() {
        const { value: org } = await Swal.fire({
            title: 'Enter organization name',
            input: 'text',
            inputLabel: 'Organization:',
            showCancelButton: true,
            inputValidator: (value) => {
                if (!value) {
                return 'You need to write something!'
                }
                if (value.includes(" ")) {
                    return 'Organization names must not have blank spaces'
                }
            }
        })
        if(org) {
            const organization = {
                "organizationName": org
            };

            function postWebhook(data) {
                return new Promise(function (resolve, reject){
                    fetch('/github/webhook', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data),
                    })
                    .then(
                        (response) => response.json().then(data =>{
                            resolve(data);
                        }),
                        (error) => {reject(error);}
                    );
                })
            }

            var result = await postWebhook(organization)
            if(result.hasOwnProperty('message')){
                msg = JSON.stringify(JSON.parse(JSON.stringify(result)).message)
                Swal.fire("Webhook creation failed", msg.replace(/["]/g, ""), "error")
            }
            else {
                Swal.fire("Webhook created", "Webhook was created successfully", "success")
            }  
        }
    }
</script>

<!-- <script>
    function myFunction(id) {
        var x = document.getElementById(id);
        if (x.type === "password") {
            x.type = "text";
        } else {
            x.type = "password";
        }
    }
</script> -->
{{end}}